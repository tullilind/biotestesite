<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preparo para Exames - Bioteste</title>
    
    <link rel="stylesheet" href="style.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CONFIGURAÇÕES GERAIS --- */
        :root {
            --primary: #0056b3;
            --primary-dark: #003d80;
            --accent: #00c6ff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f8faff;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            margin: 0; padding: 0; color: var(--text-dark);
        }

        #bioteste-header { position: relative; z-index: 99999 !important; }

        /* --- HERO SECTION --- */
        .page-hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 70px 20px 100px 20px;
            text-align: center; color: white;
            position: relative;
        }
        .hero-content { max-width: 800px; margin: 0 auto; position: relative; z-index: 2; }
        .page-hero h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
        .page-hero p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 0; }

        /* --- BARRA DE PESQUISA --- */
        .search-container {
            max-width: 700px; margin: -40px auto 30px auto; padding: 0 20px;
            position: relative; z-index: 10;
        }
        .search-box {
            background: white; padding: 12px 20px; border-radius: 50px;
            display: flex; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; transition: box-shadow 0.3s;
        }
        .search-box:focus-within { box-shadow: 0 15px 35px rgba(0, 86, 179, 0.15); border-color: var(--primary); }
        .search-box i { font-size: 24px; color: var(--primary); margin-right: 15px; }
        .search-box input {
            flex: 1; border: none; outline: none; font-size: 1.1rem;
            padding: 5px 0; color: var(--text-dark); font-family: 'Inter', sans-serif;
        }
        .search-box input::placeholder { color: #94a3b8; }
        
        /* Contador de resultados */
        .results-count {
            text-align: center; font-size: 0.9rem; color: var(--text-light); margin-bottom: 20px; opacity: 0.8;
        }

        /* --- LISTA DE EXAMES --- */
        .exams-container { max-width: 900px; margin: 0 auto 60px auto; padding: 0 20px; min-height: 400px; }
        
        .exam-item {
            background: white; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
            overflow: hidden; transition: 0.2s; cursor: pointer;
        }
        /* Efeito hover suave para não pesar no mobile */
        .exam-item:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); border-color: #bfdbfe; }

        .exam-header {
            padding: 18px 25px; display: flex; align-items: center; justify-content: space-between;
            background: #fff;
        }
        .exam-name { display: flex; align-items: center; gap: 15px; font-weight: 600; font-size: 1.1rem; color: var(--text-dark); }
        .exam-icon-circle {
            width: 40px; height: 40px; background: #eff6ff; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; color: var(--primary);
        }
        .toggle-icon { color: #cbd5e1; transition: 0.3s; }
        
        /* Detalhes do Exame */
        .exam-details {
            max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out;
            background: #f8fafc; border-top: 1px solid #f1f5f9;
        }
        .details-content { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

        .detail-box h4 { margin: 0 0 8px 0; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .detail-box p { margin: 0; color: #475569; line-height: 1.6; font-size: 0.95rem; }
        .detail-list { list-style: none; padding: 0; margin: 0; }
        .detail-list li { margin-bottom: 8px; color: #475569; font-size: 0.95rem; display: flex; align-items: start; gap: 10px; }
        .detail-list li::before { content: ''; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; margin-top: 8px; flex-shrink: 0; }

        /* Classe ativa */
        .exam-item.active .exam-details { max-height: 1000px; /* Alto o suficiente para conteúdo grande */ }
        .exam-item.active .toggle-icon { transform: rotate(180deg); color: var(--primary); }
        .exam-item.active { border-color: #bfdbfe; box-shadow: 0 4px 12px rgba(0, 86, 179, 0.08); }

        /* Estados */
        #loading-msg, #error-msg, #no-results, #end-of-list {
            text-align: center; padding: 40px; color: var(--text-light); display: none;
        }
        #loading-msg { display: block; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .details-content { grid-template-columns: 1fr; gap: 20px; }
            .exam-header { padding: 15px 20px; }
            .exam-name { font-size: 1rem; }
            .search-container { padding: 0 15px; margin-top: -30px; }
        }
    </style>
</head>
<body>

    <div id="bioteste-header"></div>

    <main>
        <section class="page-hero">
            <div class="hero-content">
                <h1>Instruções de Preparo</h1>
                <p>Consulte orientações de jejum e coleta para seus exames.</p>
            </div>
        </section>

        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Busque por nome (ex: Hemograma, Vitamina D)..." autocomplete="off">
            </div>
        </div>

        <div class="results-count" id="resultsCount"></div>

        <div class="exams-container" id="examsList">
            <div id="loading-msg">
                <div class="loader"></div>
                <p>Carregando banco de dados...</p>
            </div>
            
            <div id="error-msg">
                <span class="material-symbols-rounded" style="font-size: 48px; color: #ef4444;">cloud_off</span>
                <p>Não foi possível carregar os exames.<br>Verifique sua conexão ou o arquivo de dados.</p>
            </div>

            <div id="no-results">
                <span class="material-symbols-rounded" style="font-size: 48px; opacity: 0.3;">search_off</span>
                <p>Nenhum exame encontrado com este termo.</p>
            </div>
            
            <div id="end-of-list" style="padding: 20px; font-size: 0.85rem; opacity: 0.6;">
                Você chegou ao fim da lista.
            </div>
        </div>
    </main>

    <div id="bioteste-footer"></div>
    <script src="menurodape.js"></script>

    <script>
        const listContainer = document.getElementById('examsList');
        const searchInput = document.getElementById('searchInput');
        const loadingMsg = document.getElementById('loading-msg');
        const errorMsg = document.getElementById('error-msg');
        const noResults = document.getElementById('no-results');
        const endOfListMsg = document.getElementById('end-of-list');
        const resultsCountLabel = document.getElementById('resultsCount');

        let allExamsDB = [];      // Todos os 1000+ exames
        let currentFiltered = []; // Lista filtrada pela busca atual
        let displayedCount = 0;   // Quantos estão na tela agora
        const BATCH_SIZE = 50;    // Carrega 50 por vez (Performance)

        // 1. Carrega o JSON (Simulando API)
        async function loadDatabase() {
            try {
                // Tenta carregar o arquivo exames.json
                const response = await fetch('exames.json');
                if (!response.ok) throw new Error('Falha no arquivo');
                
                allExamsDB = await response.json();
                
                // Ordena alfabeticamente para ficar organizado
                allExamsDB.sort((a, b) => a.nome.localeCompare(b.nome));

                // Inicializa a lista completa
                currentFiltered = allExamsDB;
                loadingMsg.style.display = 'none';
                
                // Renderiza o primeiro lote
                renderNextBatch();
                updateCountLabel();

            } catch (error) {
                console.error(error);
                loadingMsg.style.display = 'none';
                errorMsg.style.display = 'block';
            }
        }

        // 2. Renderiza o próximo lote (Scroll Infinito)
        function renderNextBatch() {
            const total = currentFiltered.length;
            if (displayedCount >= total) {
                if(total > 0) endOfListMsg.style.display = 'block';
                return;
            }

            endOfListMsg.style.display = 'none';
            const nextBatch = currentFiltered.slice(displayedCount, displayedCount + BATCH_SIZE);
            
            // Fragmento de documento para não "piscar" a tela (Melhora performance)
            const fragment = document.createDocumentFragment();

            nextBatch.forEach(exam => {
                const card = createExamCard(exam);
                fragment.appendChild(card);
            });

            // Adiciona tudo de uma vez antes das mensagens de status
            listContainer.insertBefore(fragment, loadingMsg);
            displayedCount += nextBatch.length;
        }

        // 3. Cria o HTML de um único Card
        function createExamCard(exam) {
            const div = document.createElement('div');
            div.className = 'exam-item';
            
            // Monta lista de instruções
            let instrHTML = '';
            if (exam.instrucoes && Array.isArray(exam.instrucoes)) {
                instrHTML = exam.instrucoes.map(i => `<li>${i}</li>`).join('');
            } else {
                instrHTML = '<li>Siga as orientações gerais do laboratório.</li>';
            }

            div.innerHTML = `
                <div class="exam-header">
                    <div class="exam-name">
                        <div class="exam-icon-circle">
                            <span class="material-symbols-rounded">${exam.icone || 'science'}</span>
                        </div>
                        ${exam.nome}
                    </div>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="exam-details">
                    <div class="details-content">
                        <div class="detail-box">
                            <h4><i class="far fa-clock"></i> Jejum e Preparo</h4>
                            <p>${exam.jejum || 'Sem restrições específicas.'}</p>
                        </div>
                        <div class="detail-box">
                            <h4><i class="fas fa-list-ul"></i> Instruções de Coleta</h4>
                            <ul class="detail-list">${instrHTML}</ul>
                        </div>
                    </div>
                </div>
            `;

            // Evento de clique (Acordeão)
            div.querySelector('.exam-header').addEventListener('click', () => {
                // Fecha outros abertos (Opcional - pode remover se quiser permitir vários abertos)
                // document.querySelectorAll('.exam-item.active').forEach(el => {
                //     if(el !== div) el.classList.remove('active');
                // });
                div.classList.toggle('active');
            });

            return div;
        }

        // 4. Lógica de Busca (Debounce para não travar ao digitar)
        let timeout = null;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const term = e.target.value.toLowerCase().trim();
                
                // Limpa a tela
                const items = listContainer.querySelectorAll('.exam-item');
                items.forEach(el => el.remove());
                endOfListMsg.style.display = 'none';
                
                if (term === '') {
                    currentFiltered = allExamsDB;
                } else {
                    // Filtra nos 1000+ itens
                    currentFiltered = allExamsDB.filter(exam => 
                        exam.nome.toLowerCase().includes(term) || 
                        (exam.categoria && exam.categoria.toLowerCase().includes(term))
                    );
                }

                displayedCount = 0;
                
                if (currentFiltered.length === 0) {
                    noResults.style.display = 'block';
                } else {
                    noResults.style.display = 'none';
                    renderNextBatch();
                }
                updateCountLabel();
            }, 300); // Espera 300ms após parar de digitar
        });

        // 5. Scroll Infinito
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                renderNextBatch();
            }
        });

        function updateCountLabel() {
            if(searchInput.value.trim() !== '') {
                resultsCountLabel.innerText = `${currentFiltered.length} exames encontrados`;
            } else {
                resultsCountLabel.innerText = '';
            }
        }

        // Inicia
        loadDatabase();

    </script>

</body>
</html>